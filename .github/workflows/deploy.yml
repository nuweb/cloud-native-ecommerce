# =============================================================================
# Deploy to AWS
# Builds and deploys the application to AWS
# =============================================================================

name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: us-east-1
  DOMAIN_NAME: ecommerce.veeracs.info
  API_DOMAIN: api.veeracs.info

jobs:
  # ===========================================================================
  # Build Frontend Applications
  # ===========================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Shell (Host)
        run: npx nx build shell --configuration=production
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Build Products Remote
        run: npx nx build products --configuration=production
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Build Product-Detail Remote
        run: npx nx build product-detail --configuration=production
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Upload Shell artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shell-dist
          path: dist/apps/shell
          retention-days: 1

      - name: Upload Products artifacts
        uses: actions/upload-artifact@v4
        with:
          name: products-dist
          path: dist/apps/products
          retention-days: 1

      - name: Upload Product-Detail artifacts
        uses: actions/upload-artifact@v4
        with:
          name: product-detail-dist
          path: dist/apps/product-detail
          retention-days: 1

  # ===========================================================================
  # Build and Push API Docker Image
  # ===========================================================================
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push API image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cloud-native-ecommerce-api
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f apps/api/Dockerfile .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  # ===========================================================================
  # Deploy Frontend to S3/CloudFront
  # ===========================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: build-frontend
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Shell artifacts
        uses: actions/download-artifact@v4
        with:
          name: shell-dist
          path: dist/shell

      - name: Download Products artifacts
        uses: actions/download-artifact@v4
        with:
          name: products-dist
          path: dist/products

      - name: Download Product-Detail artifacts
        uses: actions/download-artifact@v4
        with:
          name: product-detail-dist
          path: dist/product-detail

      - name: Deploy Shell to S3
        run: |
          aws s3 sync dist/shell s3://cloud-native-ecommerce-shell-production \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"
          
          aws s3 cp dist/shell/index.html s3://cloud-native-ecommerce-shell-production/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Deploy Products to S3
        run: |
          aws s3 sync dist/products s3://cloud-native-ecommerce-products-production \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

      - name: Deploy Product-Detail to S3
        run: |
          aws s3 sync dist/product-detail s3://cloud-native-ecommerce-product-detail-production \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items[?@=='${{ env.DOMAIN_NAME }}']].Id" \
            --output text)
          
          if [ -n "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
          fi

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-frontend, build-api]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.build-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Website**: https://${{ env.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: https://${{ env.API_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
